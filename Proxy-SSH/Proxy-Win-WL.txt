sysctl -w net.ipv4.ip_forward=1
iptables -A FORWARD -i eth0 -j ACCEPT
iptables -A FORWARD -o eth0 -j ACCEPT
iptables -I FORWARD -i eth0 -p tcp --dport 25565 -j ACCEPT
iptables -t nat -A PREROUTING -p tcp --dport 25565 -j DNAT --to-destination 66.70.138.48:9900
iptables -t nat -A POSTROUTING -j MASQUERADE
iptables -t mangle -A PREROUTING -p icmp -j DROP

iptables -t mangle -I PREROUTING -s 66.70.138.48 -j ACCEPT
iptables -t mangle -I PREROUTING -s 194.110.13.0/24 -j ACCEPT
iptables -t mangle -I PREROUTING -s 181.214.218.71 -j ACCEPT
iptables -t mangle -I PREROUTING -s 156.146.60.0/24 -j ACCEPT
iptables -t mangle -I PREROUTING -s 181.215.176.0/24 -j ACCEPT
iptables -t mangle -N WINDOWSVALID
iptables -t mangle -N IOS
ipset create ratelimit_set hash:ip timeout 32767
ipset create perm_ban hash:ip timeout 0
iptables -t mangle -A PREROUTING -p tcp ! --syn -m conntrack --ctstate NEW -j DROP
iptables -t mangle -A PREROUTING -m conntrack --ctstate INVALID -j DROP
iptables -t mangle -A PREROUTING -p tcp -m conntrack --ctstate NEW -m tcp -m string --hex-string "|2000|" --algo kmp --from 30 --to 34 -m conntrack ! --ctstatus SEEN_REPLY -j DROP
iptables -t mangle -A PREROUTING -p tcp -m conntrack --ctstate NEW -m bpf --bytecode "23,48 0 0 0,84 0 0 240,21 0 19 64,40 0 0 6,69 17 0 8191,48 0 0 8,53 15 0 64,40 0 0 2,21 0 13 64,48 0 0 9,21 0 11 6,21 0 10 6,40 0 0 6,69 8 0 8191,177 0 0 0,80 0 0 9,21 0 5 0,80 0 0 13,69 0 3 2,80 0 0 18,21 0 1 0,6 0 0 65535,6 0 0 0" -j MARK --set-mark 2
iptables -t mangle -A PREROUTING -p tcp -m mark --mark 2 -j IOS
iptables -t mangle -A PREROUTING -p tcp -m bpf --bytecode "13,48 0 0 0,84 0 0 240,21 0 9 64,48 0 0 9,21 0 7 6,40 0 0 6,69 5 0 8191,177 0 0 0,80 0 0 13,69 0 2 2,69 1 0 16,6 0 0 65535,6 0 0 0" -j MARK --set-mark 1
iptables -t mangle -A PREROUTING -p tcp -m conntrack ! --ctstate NEW -m connbytes --connbytes 2: --connbytes-dir original --connbytes-mode packets -m mark --mark 1 -j DROP
iptables -t mangle -A PREROUTING -p tcp -m bpf --bytecode "15,48 0 0 0,84 0 0 240,21 0 11 64,48 0 0 9,21 0 9 6,40 0 0 6,69 7 0 8191,177 0 0 0,72 0 0 14,53 4 0 4096,80 0 0 13,69 0 2 16,69 0 1 8,6 0 0 65535,6 0 0 0" -j MARK --set-mark 2
iptables -t mangle -A PREROUTING -p tcp -m conntrack --ctstate ESTABLISHED,RELATED -m connbytes --connbytes 2:3 --connbytes-dir original --connbytes-mode packets -m mark ! --mark 2 -j DROP
iptables -t mangle -A PREROUTING -p tcp -m bpf --bytecode "51,48 0 0 0,84 0 0 240,21 0 47 64,48 0 0 0,84 0 0 15,21 0 17 5,48 0 0 1,21 0 15 0,40 0 0 2,37 0 13 48,53 12 0 60,40 0 0 6,69 10 0 8191,48 0 0 8,37 0 8 64,48 0 0 9,21 0 6 6,21 0 32 6,40 0 0 6,69 30 0 8191,177 0 0 0,72 0 0 2,21 8 4 22,48 0 0 9,21 0 25 6,40 0 0 6,69 23 0 8191,177 0 0 0,72 0 0 2,21 1 0 2222,21 0 19 25565,80 0 0 10,21 0 17 0,48 0 0 9,21 0 15 6,64 0 0 4,21 13 0 0,80 0 0 9,21 0 11 0,80 0 0 13,69 0 9 2,69 8 0 4,69 7 0 8,69 6 0 32,72 0 0 14,37 0 4 8191,53 3 0 65536,80 0 0 18,21 0 1 0,6 0 0 65535,6 0 0 0" -j MARK --set-mark 3
iptables -t mangle -A PREROUTING -p tcp -m mark --mark 3 -j WINDOWSVALID
iptables -t mangle -A PREROUTING -p tcp -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

iptables -t mangle -A IOS -p tcp -m connlimit --connlimit-above 3 --connlimit-mask 24 -j DROP
iptables -t mangle -A IOS -p tcp -m hashlimit --hashlimit-above 1/s --hashlimit-burst 1 --hashlimit-mode srcip,srcport --hashlimit-name ioslimit --hashlimit-htable-expire 524288 --hashlimit-srcmask 24 -j DROP
iptables -t mangle -A IOS -p tcp -m mark --mark 2 -m hashlimit --hashlimit-upto 1/m --hashlimit-burst 1 --hashlimit-mode srcip --hashlimit-name iosacce --hashlimit-htable-expire 4194304 --hashlimit-srcmask 32 -j ACCEPT
iptables -t mangle -A IOS -j DROP



iptables -t mangle -A WINDOWSVALID -m length ! --length 52:74 -j DROP
iptables -t mangle -A WINDOWSVALID -p tcp -m tcpmss ! --mss 1300:1460 -j DROP
iptables -t mangle -A WINDOWSVALID -p tcp -m tcp ! --tcp-option 3 --tcp-flags SYN SYN -j DROP
iptables -t mangle -A WINDOWSVALID -p tcp -m tcp ! --tcp-option 1 --tcp-flags SYN SYN -j DROP
iptables -t mangle -A WINDOWSVALID -p tcp -m connlimit --connlimit-above 2 --connlimit-mask 22 -j DROP
iptables -t mangle -A WINDOWSVALID -p tcp -m conntrack --ctstate NEW -m hashlimit --hashlimit-above 1/s --hashlimit-burst 1 --hashlimit-mode srcip,srcport --hashlimit-name windowslimit --hashlimit-htable-expire 99999999 --hashlimit-srcmask 24 -j SET --add-set ratelimit_set src --exist
iptables -t mangle -A WINDOWSVALID -p tcp -m hashlimit --hashlimit-above 10/m --hashlimit-burst 1 --hashlimit-mode srcip,srcport --hashlimit-name banIPS --hashlimit-htable-max 898192819 --hashlimit-htable-expire 1281996 --hashlimit-srcmask 16 -j SET --add-set perm_ban src
iptables -t mangle -A WINDOWSVALID -m set --match-set ratelimit_set src -j DROP
iptables -t mangle -A WINDOWSVALID -p tcp --syn -m mark --mark 3 -m hashlimit --hashlimit-upto 1/s --hashlimit-burst 1 --hashlimit-mode srcip --hashlimit-name winaccept --hashlimit-htable-expire 4100000 --hashlimit-srcmask 32 -m comment --comment "Drop everything marked above to make sure no bad traffic is being accepted and only accept the windows mark after all" -j ACCEPT
iptables -t mangle -A WINDOWSVALID -j DROP
iptables -t mangle -P PREROUTING DROP