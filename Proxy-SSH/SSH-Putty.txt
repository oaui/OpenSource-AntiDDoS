
iptables -t mangle -I PREROUTING -s 51.38.70.1 -j ACCEPT
iptables -t mangle -A OUTPUT -s 51.38.70.1 -j ACCEPT
iptables -t nat -A POSTROUTING -s 51.38.70.1 -j ACCEPT
iptables -t mangle -A PREROUTING -p tcp ! --syn -m conntrack --ctstate NEW -j DROP
iptables -t mangle -A PREROUTING -m conntrack --ctstate INVALID -j DROP
iptables -t raw -A PREROUTING -p icmp -j DROP
iptables -t mangle -A PREROUTING -p tcp -m bpf --bytecode "51,48 0 0 0,84 0 0 240,21 47 0 96,48 0 0 0,84 0 0 240,21 0 44 64,48 0 0 9,21 0 42 6,40 0 0 6,69 40 0 8191,177 0 0 0,72 0 0 2,21 2 0 22,21 1 0 2222,21 0 35 25565,48 0 0 9,21 0 33 6,80 0 0 13,69 0 31 2,48 0 0 8,37 0 29 32,53 28 0 255,40 0 0 2,37 0 26 50,53 25 0 68,40 0 0 6,69 23 0 8191,80 0 0 13,69 21 0 32,69 20 0 8,69 19 0 4,69 18 0 16,48 0 0 0,84 0 0 15,37 0 15 4,64 0 0 4,21 13 0 0,64 0 0 5,21 11 0 0,80 0 0 6,21 9 0 0,48 0 0 6,84 0 0 32,21 6 0 32,80 0 0 18,21 0 4 0,72 0 0 14,37 0 2 8191,53 1 0 65536,6 0 0 65535,6 0 0 0" -j MARK --set-mark 0
iptables -t mangle -A PREROUTING -p tcp -m bpf --bytecode "18,48 0 0 0,84 0 0 240,21 0 14 64,48 0 0 9,21 0 12 6,40 0 0 6,69 10 0 8191,177 0 0 0,80 0 0 13,69 0 2 16,64 0 0 20,21 4 0 1397966893,80 0 0 13,69 0 3 8,64 0 0 20,21 0 1 1397966893,6 0 0 65535,6 0 0 0" -m comment --comment "SSH Validation" -j MARK --set-mark 1
iptables -t mangle -A PREROUTING -p tcp -m comment --comment "IOS devices" -m bpf --bytecode "46,48 0 0 0,84 0 0 240,21 0 42 64,40 0 0 6,69 40 0 8191,48 0 0 8,53 38 0 64,40 0 0 2,21 0 36 64,48 0 0 0,21 0 34 69,48 0 0 9,21 0 32 6,40 0 0 6,69 30 0 8191,177 0 0 0,64 0 0 8,21 0 27 0,80 0 0 12,21 0 25 176,72 0 0 14,37 0 23 2048,53 22 0 65536,80 0 0 24,21 0 20 1,64 0 0 36,21 0 18 0,72 0 0 40,21 0 16 1026,80 0 0 42,21 0 14 0,48 0 0 1,21 0 12 0,48 0 0 9,21 0 10 6,80 0 0 9,21 0 8 0,80 0 0 13,69 0 6 2,69 5 0 16,69 4 0 8,69 3 0 32,80 0 0 18,21 0 1 0,6 0 0 65535,6 0 0 0" -j MARK --set-mark 2
iptables -t mangle -A PREROUTING -p tcp -m comment --comment "Diffie hellman" -m bpf --bytecode "23,48 0 0 0,84 0 0 240,21 0 19 64,40 0 0 2,37 0 17 1024,48 0 0 9,21 0 15 6,40 0 0 6,69 13 0 8191,177 0 0 0,72 0 0 14,53 10 0 2048,80 0 0 13,69 0 8 8,69 0 7 16,64 0 0 20,21 0 5 1252,80 0 0 24,21 0 3 11,80 0 0 25,21 0 1 20,6 0 0 65535,6 0 0 0" -j MARK --set-mark 3

iptables -t mangle -A PREROUTING -p tcp -m string --hex-string "OpenSSH" --algo bm -j DROP
iptables -t mangle -A PREROUTING -p tcp -m bpf --bytecode "24,48 0 0 0,84 0 0 240,21 0 20 64,40 0 0 2,53 0 4 54,48 0 0 9,21 0 16 6,40 0 0 6,69 14 9 8191,48 0 0 9,21 0 12 6,40 0 0 6,69 10 0 8191,177 0 0 0,72 0 0 14,21 0 2 0,80 0 0 13,69 4 0 4,177 0 0 0,80 0 0 13,69 0 2 16,69 0 1 4,6 0 0 65535,6 0 0 0" -j DROP
iptables -t mangle -A PREROUTING -p tcp -m conntrack --ctstate ESTABLISHED -j CONNMARK --restore-mark

iptables -t mangle -A PREROUTING -p tcp -m mark ! --mark 3 -m connbytes --connbytes 0:1 --connbytes-mode packets --connbytes-dir original -m mark ! --mark 0 -j DROP
iptables -t mangle -A PREROUTING -p tcp -m connbytes --connbytes 3:3 --connbytes-mode packets --connbytes-dir original -m mark ! --mark 1 -j MARK --set-mark 99
iptables -t mangle -A PREROUTING -p tcp -m connbytes --connbytes 4:4 --connbytes-mode packets --connbytes-dir original -m mark ! --mark 3 -j DROP
iptables -t mangle -A PREROUTING -p tcp -m mark --mark 99 -j DROP

iptables -t mangle -A PREROUTING -p tcp -m mark --mark 1 -j CONNMARK --save-mark


iptables -t mangle -A PREROUTING -p tcp -m conntrack --ctstate NEW -m hashlimit --hashlimit-mode srcip,srcport --hashlimit-above 1/s --hashlimit-burst 1 --hashlimit-htable-max 9999999 --hashlimit-name secHashlim --hashlimit-htable-size 817212823 --hashlimit-htable-expire 512000 --hashlimit-srcmask 16 --hashlimit-htable-gcinterval 2048 -j DROP

iptables -t mangle -A PREROUTING -p tcp -m conntrack --ctstate NEW -m connlimit --connlimit-above 2 --connlimit-mask 24 -j DROP

iptables -t mangle -A PREROUTING -p tcp --syn -m hashlimit --hashlimit-mode srcip --hashlimit-above 4/min --hashlimit-burst 2 --hashlimit-htable-max 8129119 --hashlimit-name general-syn-limit --hashlimit-htable-size 1000000000 --hashlimit-htable-expire 120000 --hashlimit-srcmask 24 --hashlimit-htable-gcinterval 4096 -j DROP


iptables -t mangle -A PREROUTING -p tcp --syn -m conntrack --ctstate NEW -m mark --mark 2 -m hashlimit --hashlimit-mode srcip --hashlimit-upto 5/m --hashlimit-burst 4 --hashlimit-htable-max 999999 --hashlimit-name IOSHash --hashlimit-htable-size 99999999 --hashlimit-htable-expire 16787 --hashlimit-srcmask 32 -j ACCEPT

iptables -t mangle -A PREROUTING -p tcp --syn -m conntrack --ctstate NEW -m bpf --bytecode "51,48 0 0 0,84 0 0 240,21 0 47 64,48 0 0 0,84 0 0 15,21 0 16 5,40 0 0 2,37 0 14 51,53 13 0 58,40 0 0 6,69 11 0 8191,48 0 0 8,37 0 9 64,53 8 0 255,48 0 0 9,21 0 6 6,21 0 33 6,40 0 0 6,69 31 0 8191,177 0 0 0,72 0 0 2,21 8 4 22,48 0 0 9,21 0 26 6,40 0 0 6,69 24 0 8191,177 0 0 0,72 0 0 2,21 1 0 2222,21 0 20 25565,64 0 0 4,21 18 0 0,48 0 0 9,21 0 16 6,80 0 0 13,69 0 14 2,69 13 0 4,69 12 0 8,69 11 0 32,69 10 0 16,72 0 0 14,37 0 8 8191,53 7 0 65536,80 0 0 18,21 0 5 0,64 0 0 8,21 0 3 0,80 0 0 12,21 0 1 128,6 0 0 65535,6 0 0 0" -m hashlimit --hashlimit-mode srcip --hashlimit-upto 5/m --hashlimit-burst 2 --hashlimit-htable-max 999999 --hashlimit-name WindowsHash --hashlimit-htable-size 817281921 --hashlimit-htable-expire 8192 --hashlimit-srcmask 32 -m comment --comment "Whitelist windows using bpf, to slow down mcstorm, change 5 to lower number" -j ACCEPT

iptables -t mangle -A PREROUTING -p tcp --syn -m conntrack --ctstate NEW -m bpf --bytecode "51,48 0 0 0,84 0 0 240,21 0 47 64,48 0 0 0,84 0 0 15,21 0 16 5,40 0 0 2,37 0 14 50,53 13 0 62,40 0 0 6,69 11 0 8191,48 0 0 8,53 9 0 64,37 0 8 0,48 0 0 9,21 0 6 6,21 0 33 6,40 0 0 6,69 31 0 8191,177 0 0 0,72 0 0 2,21 8 4 22,48 0 0 9,21 0 26 6,40 0 0 6,69 24 0 8191,177 0 0 0,72 0 0 2,21 1 0 2222,21 0 20 25565,64 0 0 4,21 18 0 0,48 0 0 9,21 0 16 6,80 0 0 13,69 0 14 2,69 13 0 4,69 12 0 8,69 11 0 32,69 10 0 16,72 0 0 14,37 0 8 8191,53 7 0 65536,80 0 0 18,21 0 5 0,64 0 0 8,21 0 3 0,80 0 0 12,21 0 1 160,6 0 0 65535,6 0 0 0" -m hashlimit --hashlimit-mode srcip --hashlimit-upto 1/m --hashlimit-burst 1 --hashlimit-htable-max 999999 --hashlimit-name LinuxHash --hashlimit-htable-size 99999999 --hashlimit-htable-expire 32676 --hashlimit-srcmask 32 -m comment --comment "Whitelist linux, ios, unix and all other shit out there, could only change hashlimit upto 2 to 1 eventually" -j ACCEPT



iptables -t mangle -A PREROUTING -p tcp -m conntrack --ctstate ESTABLISHED -j ACCEPT
iptables -t mangle -P PREROUTING DROP



nano /etc/sysctl.conf

//Kernel 
echo 100000000 > /sys/module/nf_conntrack/parameters/hashsize
net.ipv4.tcp_max_orphans = 0
net.ipv4.ip_forward = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv4.tcp_synack_retries = 0
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_rfc1337 = 1
net.ipv4.tcp_keepalive_time = 5
net.ipv4.tcp_keepalive_probes = 2
net.ipv4.tcp_keepalive_intvl = 2
net.ipv4.tcp_retries2 = 5
net.ipv4.tcp_max_syn_backlog = 999999999
net.ipv4.tcp_fin_timeout = 0
net.ipv4.tcp_tw_reuse = 0
net.ipv4.tcp_congestion_control = bbr
net.core.default_qdisc = fq
net.core.somaxconn = 999999999
net.core.rmem_max = 999999999
net.core.netdev_max_backlog = 999999999
net.netfilter.nf_conntrack_max = 99999999
net.netfilter.nf_conntrack_tcp_loose = 0
net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 30

