
iptables -t mangle -N SSHVAL

iptables -t mangle -A PREROUTING -p tcp --syn -m conntrack --ctstate NEW -m bpf --bytecode "50,48 0 0 0,84 0 0 240,21 46 0 96,48 0 0 0,84 0 0 240,21 0 43 64,48 0 0 9,21 0 41 6,40 0 0 6,69 39 0 8191,177 0 0 0,72 0 0 2,21 2 0 22,21 1 0 2222,21 0 34 25565,48 0 0 9,21 0 32 6,80 0 0 13,69 0 30 2,48 0 0 8,37 0 28 32,53 27 0 255,40 0 0 2,37 0 25 50,53 24 0 62,40 0 0 6,69 22 0 8191,80 0 0 13,69 20 0 32,69 19 0 8,69 18 0 4,69 17 0 16,48 0 0 0,84 0 0 15,37 0 14 4,64 0 0 4,21 12 0 0,64 0 0 5,21 10 0 0,80 0 0 6,21 8 0 0,48 0 0 6,84 0 0 32,21 5 0 32,80 0 0 18,21 0 3 0,72 0 0 14,21 1 0 8192,6 0 0 65535,6 0 0 0" -m comment --comment "Select a specific SYN packet to copy the mark to later on" -j CONNMARK --set-mark 1

iptables -t mangle -A PREROUTING -p tcp -m comment --comment "Route all TCP traffic including the marked SYN packet to the validation chain" -j SSHVAL




iptables -t mangle -A SSHVAL -m conntrack --ctstate ESTABLISHED -m comment --comment "Set the connmark to all established connections, includes the SSH data" -j CONNMARK --restore-mark
iptables -t mangle -A SSHVAL -p tcp -m string -m bpf --bytecode "12,48 0 0 0,84 0 0 240,21 0 8 64,48 0 0 9,21 0 6 6,40 0 0 6,69 4 0 8191,177 0 0 0,64 0 0 20,21 0 1 1397966893,6 0 0 65535,6 0 0 0" --hex-string "PuTTY" --algo bm -m comment --comment "This selects the packet which should be copied to the connmark, in this case, it will be SSH in bytecode form and the string PuTTY" -j MARK --set-mark 2
iptables -t mangle -A SSHVAL -p tcp -m mark --mark 2 -m comment --comment "Copy and save the connmark to the SSH packet which is mark 2" -j CONNMARK --save-mark
iptables -t mangle -A SSHVAL -p tcp -m connmark --mark 1 -m comment --comment "Accept the modified connmark" -j ACCEPT
iptables -t mangle -A SSHVAL -p tcp -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
iptables -t mangle -A SSHVAL -j DROP


